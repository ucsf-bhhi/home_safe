---
title: "Cleaning Demographic Data"
author: "Sara Colom"
date: "`r Sys.Date()`"
output: 
  github_document:
    df_print: kable
---


# Read in data & libraries

```{r, Read in Data & Libraries, warning = F, message = F}
source("R/helpers.R")
```

```{r}
demo_dat %>% 
  glimpse()
```


# Clean up demographic data

Make all variables of `character` lower case, trim trailing and starting white spaces and 'extra' inner spaces.

```{r}
demo_dat <- demo_dat %>% 
  mutate(across(where(is.character), clean_characters))

```

Clean APS Report Location indicator, remove "'",", ca" and " ca" from strings

```{r}
demo_dat <- demo_dat %>% 
  mutate(aps_report_location = str_replace(aps_report_location, "'", "")) %>% 
  mutate(aps_report_location = str_replace(aps_report_location, ", ca| ca|,ca", ""))
```

Examine APS Report Location

```{r}
demo_dat %>% 
  count(aps_report_location)
```

## Question for Gina

Should we drop everything from " -" (i.e. space and then dash)
```{r}
demo_dat %>%  
  count(aps_report_location) %>% 
  filter(str_detect(aps_report_location, "-")) %>% 
  filter(str_detect(aps_report_location, "-"))
```

replace all locations that contain Roseville in the name to just Roseville as a new location variable 
```{r}
demo_dat <- demo_dat %>% 
  mutate(aps_location_recode = case_when(str_detect(aps_report_location,"rosev") ~ "roseville",
                                      
                                         TRUE ~ aps_report_location))
```

sanity check
```{r}
demo_dat %>% 
  count(aps_report_location, aps_location_recode) %>% 
  filter(str_starts(aps_report_location, "r"))
```

Race_1 - replace american indian/alaskan native with american indian/alaskan native/indigenous. Replace asian with asian/asian american. Replace black/african american with black/african american/african. Replace pacific islander/native hawaiian with native hawaiian/pacific islander. Replace whte with white. Change all unknowns, including data not collected and n/a to "unknown".
```{r}
demo_dat <- demo_dat %>% 
  mutate(race_1_recode = case_when(str_detect(race_1,"americ") ~ "american indian/alaskan native/indigenous", 
                                      str_starts(race_1, "asian") ~ "asian/asian american",
                                      str_starts(race_1, "bla") ~ "black/african american/african",
                                      str_starts(race_1, "pacific i") ~ "native hawaiian/pacific islander",
                                      str_starts(race_1, "wh") ~ "white",
                                   str_detect(race_1, "unkn|#|client|collected") ~ "unknown",
                                   is.na(race_1) ~ "unknown",
                                      
                                         TRUE ~ race_1))
```

Sanity check
```{r}
demo_dat %>% 
  count(race_1, race_1_recode)
```

race_2 - doing the same as for race_1, and replacing no applicable with not applicable, updating "unknown". For those who put an ethnicity response in race_2, replacing with "unknown" and updating those in the ethnicity variable. 

```{r}
demo_dat <- demo_dat %>% 
  mutate(race_2_recode = case_when(str_starts(race_2,"americ") ~ "american indian/alaskan native/indigenous", 
                                      str_starts(race_2, "asian") ~ "asian/asian american",
                                      str_starts(race_2, "bla") ~ "black/african american/african",
                                      str_starts(race_2, "pacific i") ~ "native hawaiian/pacific islander",
                                      str_starts(race_2, "wh") ~ "white",
                                   str_detect(race_2, "hisp") ~ "unknown",
                                   str_detect(race_2, "unknown|unable|refused|not collected|applicable|verified|#|client|mex") ~ "unknown",
                                   is.na(race_2) ~ "unknown",
                                      
                                         TRUE ~ race_2))
```

Sanity check for race_2
```{r}
demo_dat %>% 
  count(race_2, race_2_recode)
```


Ethnicity - replace all instances of different spellings or orders of hispanic/latino/a/x to hispanic/latinx. Changing mexican/chicano, cuban, other hispanic/latino, and puerto rican to hispanic/latinx. Also, replace all instances of different spellings or orders of not hispanic/latino to non-hispanic/latinx 

```{r}
demo_dat <- demo_dat %>% 
  mutate(ethnicity_recode = case_when(str_starts(ethnicity, "no") ~ "non-hispanic/latinx",
                                      str_detect(ethnicity,"hispa") ~ "hispanic/latinx", 
                                      str_detect(race_2, "not hispanic|no hispanic") ~ "non-hispanic/latinx",
                                      str_detect(race_2, "hispanic") ~ "hispanic/latinx",
                                      str_detect(race_2, "mex") ~ "hispanic/latinx",
                                      str_detect(ethnicity, "mex|puerto|cuban") ~ "hispanic/latinx",
                                      str_detect(ethnicity, "unknown|#|applicable|data not|client|missing|rent") ~ "unknown",
                                      is.na(ethnicity) ~ "unknown",
                                      
                                      
                                         TRUE ~ ethnicity))
```

Sanity check 
```{r}
demo_dat %>% 
  count(ethnicity, race_2, ethnicity_recode) 
```

current_martial_status - replace unknowns and data not collected with "unknown". 

### Question: How would we like to recode domestic partnership? (Lump with married?) What to do with single? (100/103 records with single are from LA) ALSO, what to do with "no"? (both from Merced, might get fixed when column shift issue is solved)
```{r}
demo_dat <- demo_dat %>% 
  mutate(current_marital_recode = case_when(str_detect(current_marital_status, "unknown|#|applicable|data not") ~ "unknown",
                                      is.na(current_marital_status) ~ "unknown",
                                         TRUE ~ current_marital_status))
```

Sanity check for marital status
```{r}
demo_dat %>% 
  count(current_marital_status, current_marital_recode)
```

sexual_orientation - changed straight to "straight/heterosexual" to match CDSS variable. Changed all unknown or declined or missing responses to "unknown"

### Question: do we want to lump "another sexual orientation" or "other" into something? Perhaps an "other sexual orientation" bucket?
```{r}
demo_dat <- demo_dat %>% 
  mutate(sexual_orientation_recode = case_when(str_detect(sexual_orientation, "strai") ~ "straight/heterosexual",
                                               str_detect(sexual_orientation, "unknown|#|client|decline|data not") ~ "unknown",
                                      is.na(sexual_orientation) ~ "unknown",
                                         TRUE ~ sexual_orientation))
```

Sanity check
```{r}
demo_dat %>% 
  count(sexual_orientation, sexual_orientation_recode)
```

preferred_language - leaving alone the responses that don't appear to be languages for now. Combining the mandarin/cantonese responses. Changing unknowns and missings to "unknown". 
```{r}
demo_dat <- demo_dat %>% 
  mutate(preferred_language_recode = case_when(str_detect(preferred_language, "mandarin") ~ "mandarin/cantonese",
                                               str_detect(preferred_language, "unknown|#|data not") ~ "unknown",
                                               is.na(preferred_language) ~ "unknown",
                                               TRUE ~ preferred_language))
```

Sanity check
```{r}
demo_dat %>% 
  count(preferred_language, preferred_language_recode)
```

veteran_status - combining client refused, unknown, missing, unable to verify, verified by staff, and "b" into "unknown". Leaving the response "none" for now to see if it's a column shift issue, will revisit. 

### Question: I'm guessing "none" should be lumped with "no"?
```{r}
demo_dat <- demo_dat %>% 
  mutate(veteran_status_recode = case_when(str_detect(veteran_status, "client|unknown|#|verif|b|data not|n/a") ~ "unknown",
                                           is.na(veteran_status) ~ "unknown",
                                           TRUE ~ veteran_status))
```

Sanity check
```{r}
demo_dat %>% 
  count(veteran_status, veteran_status_recode)
```

medi_cal - combining the unknowns into one "unknown"
```{r}
demo_dat <- demo_dat %>% 
  mutate(medi_cal_recode = case_when(str_detect(medi_cal, "client|unknown|#|data not") ~ "unknown",
                                           is.na(medi_cal) ~ "unknown",
                                           TRUE ~ medi_cal))
```

Sanity check 
```{r}
demo_dat %>% 
  count(medi_cal, medi_cal_recode)
```


doing the same for medicare
```{r}
demo_dat <- demo_dat %>% 
  mutate(medicare_recode = case_when(str_detect(medicare, "client|unknown|#|data not|n/a") ~ "unknown",
                                           is.na(medicare) ~ "unknown",
                                           TRUE ~ medicare))
```

Sanity check 
```{r}
demo_dat %>% 
  count(medicare, medicare_recode)
```

representative payee or conservator: data is real messy, seems to have many values that shouldn't be in this column. Will hold off until new dataset comes in to assess how much is a column shift issue. 
```{r}
demo_dat %>% 
  count(representative_payee_or_conservator)
```

living situation upon entry - changing the numbers to unknown for now, I'm guessing many of them are rent amount, but will wait for column shift fix to verify. Matching responses with dropdown options: combining all "homeless" responses into "homeless." Recoding "hotel" as temporary housing. Changing rent by client, rental by client, etc and "lease holder" into "rent leaseholder". Recoding descriptions of owner, whether living alone or with others, as "owner" (excluding the records where it says rental by owner).Changing "programpermanent-residential program" to "permanent-residential program" as that seems like a typo. Recoding "hospital facility" to "other". Combining unknown, n/a, data not collected as unknown. 

###Questions for the group:
    "hotel with rights" - I'm thinking this shouldn't be temporary housing, what do you all think? (currently it is lumped into temporary housing in recode)
    "with others no rent"/"with others" - Is this akin to "staying with friends/family on a temp basis (temporary housing), is it "other permanent housing"?
    "board and care facility"/"residential care facility"/SNF - in the dropdown, these are in both temporary- residential program and permanent- residential program options. 
    "rent by owner" - is this rent leaseholder? (that is where I put it for now)
    "shared housing"/"living in shared house"/"living alone" - rent leaseholder? other permanent housing? Could also be owner I suppose?
    "living with family"/"living with relative" - this could be either temporary housing or other permanent housing..
    "with others rent" - my guess is this should go under "other permanent housing" which includes in () "renting a room without a lease? 
    
```{r}
demo_dat <- demo_dat %>% 
  mutate(living_sit_entry_recode = case_when(str_detect(living_situation_upon_entry, "1|2|3|4|5|6|7|8|9|0") ~ "unknown",
                                            str_detect(living_situation_upon_entry, "homeless|homless|unsheltered") ~ "homeless",
                                             str_detect(living_situation_upon_entry, "hotel") ~ "temporary housing",
                                             str_detect(living_situation_upon_entry, "rent by|rental by|lease holder") ~ "rent leaseholder",
                                             str_detect(living_situation_upon_entry, "owned|owner") ~ "owner",
                                             str_detect(living_situation_upon_entry, "programperm") ~ "permanent- residential program",
                                             str_detect(living_situation_upon_entry, "hospital") ~ "other",
                                             str_detect(living_situation_upon_entry, "data not|unknown") ~ "unknown",
                                             is.na(living_situation_upon_entry) ~ "unknown",
                                          TRUE ~ living_situation_upon_entry))
```


sanity check
```{r}
demo_dat %>% 
  count(living_situation_upon_entry, living_sit_entry_recode)
```

And! for a breakdown of which counties these hard to classify ones are coming up (it's many different ones it seems):
```{r}
demo_dat %>% 
  count(living_sit_entry_recode, reporting_agency)
```

client homeless within the last 3 years - answers should be yes or no. Leaving numbers alone for now. Changing 3 years or longer, within the last year, within the last 3 years, currently homeless to "yes". Changing client was not homeless to "no". Combining doesn't know, refused, data not collected, unknown, blank as "unknown".

Question: one response that is "n" - I'm guessing this might be no? But there is another response with n/a, which is what they might've been going for?
```{r}
demo_dat <- demo_dat %>% 
  mutate(client_homeless_last_three_years_recode = case_when(str_detect(client_homeless_within_the_last_three_years, "three years or|within the last|currently homel") ~ "yes",
                                                  str_detect(client_homeless_within_the_last_three_years, "client was not homele") ~ "no",
                                                  str_detect(client_homeless_within_the_last_three_years, "doesn't know|refused|n/a|data not") ~ "unknown",
                                                  is.na(client_homeless_within_the_last_three_years) ~ "unknown",
                                                  TRUE ~ client_homeless_within_the_last_three_years))
```

Sanity check
```{r}
demo_dat %>% 
  count(client_homeless_within_the_last_three_years, client_homeless_last_three_years_recode)
```

Number of times homeless in the past 3 years - changing 0 to "client was not homeless", 1 to "one time", 2 to "two times", 3 to "three times" 4 and 4+ to "four or more times". Changing any "0-x" responses to unknown, since it seems the exact number is not known.. Changing refused, doesn't know, n/a, blank to "unknown". 

### Question: 
  99 is a response with 1366 answers, I'm wondering if this is the same as unknown? (like people we're just using a very big number as a placeholder?) Or just a very large number of times someone (many people) were unhoused? (Putting in unknown for now)
  0-3 - where to put this one? (putting in unknown for now)
  "currently homeless" - perhaps should just change to unknown? (unsure also if this is a column shift issue, same with "yes" and "no", leaving alone for now)
  
```{r}
demo_dat <- demo_dat %>% 
  mutate(number_times_homeless_recode = case_when(str_equal(number_of_times_homelessness_occurred_in_the_last_three_years, "0") ~ "client was not homeless",
                                                  str_detect(number_of_times_homelessness_occurred_in_the_last_three_years, "0-|doesn't know|refused|data not|free form te|99") ~ "unknown",
                                                  str_equal(number_of_times_homelessness_occurred_in_the_last_three_years, "1") ~ "one time",
                                                  str_equal(number_of_times_homelessness_occurred_in_the_last_three_years, "2") ~ "two times",
                                                  str_equal(number_of_times_homelessness_occurred_in_the_last_three_years, "3") ~ "three times",
                                                  str_detect(number_of_times_homelessness_occurred_in_the_last_three_years, "0|1|2|3|4|5|6|7|8|9|four") ~ "four or more times",
                                                  is.na(number_of_times_homelessness_occurred_in_the_last_three_years) ~ "unknown",
                                                  TRUE ~ number_of_times_homelessness_occurred_in_the_last_three_years))
```

sanity check
```{r}
demo_dat %>% 
  count(number_of_times_homelessness_occurred_in_the_last_three_years, number_times_homeless_recode)
```

Total duration of homelessness - Changing "0" to "client was not homeless". Leaving "yes" and "no" responses for now, as I think they're a column shift issue. 


### Questions:
  99 - same question as number of times
  responses like "1", "2" - no units.. so not sure. My guess would be those are the number of months? (left as is for now)
  "within the last 3 years" - can't really take a guess at duration, besides saying it's not more than 3 years?
  "six months to one year" "& months to one year" - what to do?
  
```{r}
demo_dat <- demo_dat %>% 
  mutate(total_duration_homeless_recode = case_when(str_equal(total_duration_of_homelessness, "0") ~ "client was not homeless",
                                                    
                                                    TRUE ~ total_duration_of_homelessness))
```





Counts of `gender`

```{r}
demo_dat %>% 
  count(race_1, gender_identity)
```

  - Ask Gina, is the data transposition between `race` variables and `gender` being corrected prior to getting to us?

What does the `gender` data look like when `race_1` equals`transgender` ,`female` or `male`

```{r}
demo_dat %>% 
  filter(race_1 %in% c("female", "male", "transgender")) %>% 
  count(gender_identity, race_1)
```

Was all the data with this issue just a matter of a column shift???

One solution (remove these--re-shift and then re add)

```{r}
shifted_data <- demo_dat %>% 
    filter(race_1 %in% c("female", "male", "transgender")) 

# Anti join, remove shifted data
demo_dat <- demo_dat %>% 
      filter(!race_1 %in% c("female", "male", "transgender")) 


# Fix the shifted data

shifted_data <- shifted_data %>% 
  mutate(
    location_of_participation = gender_identity,
    gender_identity = race_1,
    race_1 = race_2,
    race_2 = ethnicity
  )

```

Glimpse shifted data

```{r}
shifted_data %>% 
  count(gender_identity)

shifted_data %>% 
  count(race_1)

shifted_data %>% 
  count(ethnicity)
```

Looks good, now re-add the shifted data BACK to the main demo_dat.

```{r}
demo_dat <- demo_dat %>% 
  bind_rows(shifted_data)

# Remove the shifted data subset from RAM

rm(shifted_data)
```

Check data dimensions.

```{r}
demo_dat %>% 
  dim()
```

# Re-coding variables

```{r}


```
