---
title: "Cleaning Demographic Data"
author: "Sara Colom"
date: "`r Sys.Date()`"
output: 
  github_document:
    df_print: kable
---


# Read in data & libraries

```{r, Read in Data & Libraries, warning = F, message = F}
source("R/helpers.R")
```

```{r}
demo_dat %>% 
  glimpse()
```


# Clean up demographic data

Make all variables of `character` lower case, trim trailing and starting white spaces and 'extra' inner spaces.

```{r}
demo_dat <- demo_dat %>% 
  mutate(across(where(is.character), clean_characters))

```

Clean APS Report Location indicator, remove "'",", ca" and " ca" from strings

```{r}
demo_dat <- demo_dat %>% 
  mutate(aps_report_location = str_replace(aps_report_location, "'", "")) %>% 
  mutate(aps_report_location = str_replace(aps_report_location, ", ca| ca|,ca", ""))
```

Examine APS Report Location

```{r}
demo_dat %>% 
  count(aps_report_location)
```

## Question for Gina

Should we drop everything from " -" (i.e. space and then dash)
```{r}
demo_dat %>%  
  count(aps_report_location) %>% 
  filter(str_detect(aps_report_location, "-")) %>% 
  filter(str_detect(aps_report_location, "-"))
```

replace all locations that contain Roseville in the name to just Roseville as a new location variable 
```{r}
demo_dat <- demo_dat %>% 
  mutate(aps_location_recode = case_when(str_detect(aps_report_location,"rosev") ~ "roseville",
                                      
                                         TRUE ~ aps_report_location))
```

sanity check
```{r}
demo_dat %>% 
  count(aps_report_location, aps_location_recode) %>% 
  filter(str_starts(aps_report_location, "r"))
```

Race_1 - replace american indian/alaskan native with american indian/alaskan native/indigenous. Replace asian with asian/asian american. Replace black/african american with black/african american/african. Replace pacific islander/native hawaiian with native hawaiian/pacific islander. Replace whte with white. Change all unknowns, including data not collected and n/a to "unknown".
```{r}
demo_dat <- demo_dat %>% 
  mutate(race_1_recode = case_when(str_detect(race_1,"americ") ~ "american indian/alaskan native/indigenous", 
                                      str_starts(race_1, "asian") ~ "asian/asian american",
                                      str_starts(race_1, "bla") ~ "black/african american/african",
                                      str_starts(race_1, "pacific i") ~ "native hawaiian/pacific islander",
                                      str_starts(race_1, "wh") ~ "white",
                                   str_detect(race_1, "unkn|#|client|collected") ~ "unknown",
                                   is.na(race_1) ~ "unknown",
                                      
                                         TRUE ~ race_1))
```

Sanity check
```{r}
demo_dat %>% 
  count(race_1, race_1_recode)
```

race_2 - doing the same as for race_1, and replacing no applicable with not applicable, updating "unknown". For those who put an ethnicity response in race_2, replacing with "unknown" and updating those in the ethnicity variable. 

```{r}
demo_dat <- demo_dat %>% 
  mutate(race_2_recode = case_when(str_starts(race_2,"americ") ~ "american indian/alaskan native/indigenous", 
                                      str_starts(race_2, "asian") ~ "asian/asian american",
                                      str_starts(race_2, "bla") ~ "black/african american/african",
                                      str_starts(race_2, "pacific i") ~ "native hawaiian/pacific islander",
                                      str_starts(race_2, "wh") ~ "white",
                                   str_detect(race_2, "hisp") ~ "unknown",
                                   str_detect(race_2, "unknown|unable|refused|not collected|applicable|verified|#|client|mex") ~ "unknown",
                                   is.na(race_2) ~ "unknown",
                                      
                                         TRUE ~ race_2))
```

Sanity check for race_2
```{r}
demo_dat %>% 
  count(race_2, race_2_recode)
```


Ethnicity - replace all instances of different spellings or orders of hispanic/latino/a/x to hispanic/latinx. Changing mexican/chicano, cuban, other hispanic/latino, and puerto rican to hispanic/latinx. Also, replace all instances of different spellings or orders of not hispanic/latino to non-hispanic/latinx 

```{r}
demo_dat <- demo_dat %>% 
  mutate(ethnicity_recode = case_when(str_starts(ethnicity, "no") ~ "non-hispanic/latinx",
                                      str_detect(ethnicity,"hispa") ~ "hispanic/latinx", 
                                      str_detect(race_2, "not hispanic|no hispanic") ~ "non-hispanic/latinx",
                                      str_detect(race_2, "hispanic") ~ "hispanic/latinx",
                                      str_detect(race_2, "mex") ~ "hispanic/latinx",
                                      str_detect(ethnicity, "mex|puerto|cuban") ~ "hispanic/latinx",
                                      str_detect(ethnicity, "unknown|#|applicable|data not|client|missing|rent") ~ "unknown",
                                      is.na(ethnicity) ~ "unknown",
                                      
                                      
                                         TRUE ~ ethnicity))
```

Sanity check 
```{r}
demo_dat %>% 
  count(ethnicity, race_2, ethnicity_recode) 
```

current_martial_status - replace unknowns and data not collected with "unknown". 

### Question: How would we like to recode domestic partnership? (Lump with married?) What to do with single? (100/103 records with single are from LA) ALSO, what to do with "no"? (both from Merced, might get fixed when column shift issue is solved)
```{r}
demo_dat <- demo_dat %>% 
  mutate(current_marital_recode = case_when(str_detect(current_marital_status, "unknown|#|applicable|data not") ~ "unknown",
                                      is.na(current_marital_status) ~ "unknown",
                                         TRUE ~ current_marital_status))
```

Sanity check for marital status
```{r}
demo_dat %>% 
  count(current_marital_status, current_marital_recode)
```

sexual_orientation - changed straight to "straight/heterosexual" to match CDSS variable. Changed all unknown or declined or missing responses to "unknown"

### Question: do we want to lump "another sexual orientation" or "other" into something? Perhaps an "other sexual orientation" bucket?
```{r}
demo_dat <- demo_dat %>% 
  mutate(sexual_orientation_recode = case_when(str_detect(sexual_orientation, "strai") ~ "straight/heterosexual",
                                               str_detect(sexual_orientation, "unknown|#|client|decline|data not") ~ "unknown",
                                      is.na(sexual_orientation) ~ "unknown",
                                         TRUE ~ sexual_orientation))
```

Sanity check
```{r}
demo_dat %>% 
  count(sexual_orientation, sexual_orientation_recode)
```

preferred_language - leaving alone the responses that don't appear to be languages for now. Combining the mandarin/cantonese responses. Changing unknowns and missings to "unknown". 
```{r}
demo_dat <- demo_dat %>% 
  mutate(preferred_language_recode = case_when(str_detect(preferred_language, "mandarin") ~ "mandarin/cantonese",
                                               str_detect(preferred_language, "unknown|#|data not") ~ "unknown",
                                               is.na(preferred_language) ~ "unknown",
                                               TRUE ~ preferred_language))
```

Sanity check
```{r}
demo_dat %>% 
  count(preferred_language, preferred_language_recode)
```

veteran_status - combining client refused, unknown, missing, unable to verify, verified by staff, and "b" into "unknown". Leaving the response "none" for now to see if it's a column shift issue, will revisit. 

### Question: I'm guessing "none" should be lumped with "no"?
```{r}
demo_dat <- demo_dat %>% 
  mutate(veteran_status_recode = case_when(str_detect(veteran_status, "client|unknown|#|verif|b|data not|n/a") ~ "unknown",
                                           is.na(veteran_status) ~ "unknown",
                                           TRUE ~ veteran_status))
```

Sanity check
```{r}
demo_dat %>% 
  count(veteran_status, veteran_status_recode)
```

medi_cal - combining the unknowns into one "unknown"
```{r}
demo_dat <- demo_dat %>% 
  mutate(medi_cal_recode = case_when(str_detect(medi_cal, "client|unknown|#|data not") ~ "unknown",
                                           is.na(medi_cal) ~ "unknown",
                                           TRUE ~ medi_cal))
```

Sanity check 
```{r}
demo_dat %>% 
  count(medi_cal, medi_cal_recode)
```


doing the same for medicare
```{r}
demo_dat <- demo_dat %>% 
  mutate(medicare_recode = case_when(str_detect(medicare, "client|unknown|#|data not|n/a") ~ "unknown",
                                           is.na(medicare) ~ "unknown",
                                           TRUE ~ medicare))
```

Sanity check 
```{r}
demo_dat %>% 
  count(medicare, medicare_recode)
```

representative payee or conservator: data is real messy, seems to have many values that shouldn't be in this column. Will hold off until new dataset comes in to assess how much is a column shift issue. 
```{r}
demo_dat %>% 
  count(representative_payee_or_conservator)
```

living situation upon entry - leaving the numbers alone for now, I'm guessing many of them are rent amount, but will wait for column shift fix. 






Counts of `gender`

```{r}
demo_dat %>% 
  count(race_1, gender_identity)
```

  - Ask Gina, is the data transposition between `race` variables and `gender` being corrected prior to getting to us?

What does the `gender` data look like when `race_1` equals`transgender` ,`female` or `male`

```{r}
demo_dat %>% 
  filter(race_1 %in% c("female", "male", "transgender")) %>% 
  count(gender_identity, race_1)
```

Was all the data with this issue just a matter of a column shift???

One solution (remove these--re-shift and then re add)

```{r}
shifted_data <- demo_dat %>% 
    filter(race_1 %in% c("female", "male", "transgender")) 

# Anti join, remove shifted data
demo_dat <- demo_dat %>% 
      filter(!race_1 %in% c("female", "male", "transgender")) 


# Fix the shifted data

shifted_data <- shifted_data %>% 
  mutate(
    location_of_participation = gender_identity,
    gender_identity = race_1,
    race_1 = race_2,
    race_2 = ethnicity
  )

```

Glimpse shifted data

```{r}
shifted_data %>% 
  count(gender_identity)

shifted_data %>% 
  count(race_1)

shifted_data %>% 
  count(ethnicity)
```

Looks good, now re-add the shifted data BACK to the main demo_dat.

```{r}
demo_dat <- demo_dat %>% 
  bind_rows(shifted_data)

# Remove the shifted data subset from RAM

rm(shifted_data)
```

Check data dimensions.

```{r}
demo_dat %>% 
  dim()
```

# Re-coding variables

```{r}


```
