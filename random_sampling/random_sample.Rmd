---
title: "Random sample"
author: "Sara Colom"
date: "`r Sys.Date()`"
output: 
  github_document:
    df_print: kable
---

# Read libraries and data

```{r, message = F}
library(dplyr)
library(tidyr)
library(stringr)

path_to_proj <- Sys.getenv("HOME_SAFE")

raw <- readxl::read_excel(paste(path_to_proj, 
                                "/Quantitative/data/report_1_data/home_safe_data_upload_090623.xlsx", 
                                sep = "")) %>% 
  janitor::clean_names()
```
Raw data size.

```{r}
raw %>% 
  dim()
```

Number of unique ID's in the data.

```{r}
raw %>% 
  count(id) %>% 
  nrow()
```
# Filters

  - Option 1: Filter for cases with `case_start_date` on or after `10/01/2022` with at least ONE intervention **OR**
  - Option 2: Has at least one intervention with date 10/1/22 or later (regardless of case start date or blank start date)

```{r}
dim(raw)

dat <- raw %>% 
  mutate(case_start_date_recode = case_when(str_detect(case_start_date, ".427") ~ "2019-04-16",
                                            str_detect(case_start_date, ".527") ~ "2022-01-14",
                                            TRUE ~ case_start_date)) %>% 
  mutate(case_start_date_recode = lubridate::ymd(case_start_date_recode)) 

dat <- dat %>% 
  mutate(across(ends_with("_date") & starts_with("intervention"), lubridate::ymd))


op_1 <- dat %>% 
    filter(case_start_date_recode >= lubridate::ymd("2022-10-01"))

dim(op_1)
```

Filter those where ALL intervention types are either `NA` or state `No Intervention`

```{r}
interv <- op_1 %>% 
  select(id, case, ends_with("type")) %>% 
  pivot_longer(ends_with("type"), names_to = "intervention", values_to = "intervention_type")

interv %>% 
  count(intervention_type)
```

To simplify the filter algorithim, I will make values binary where an intervention value = `1` and `NA` or `No Intervention` = `O`

```{r}
interv <- interv %>% 
  mutate(intervention_binary = case_when(is.na(intervention_type) ~ 0L,
                                         intervention_type == "No Intervention" ~ 0L,
                                         TRUE ~ 1L))
head(interv)

interv_summary <- interv %>% 
  group_by(id, case) %>% 
  summarise(total_interventions = sum(intervention_binary, na.rm = T))
```


Based on this list, we want to `exclude` individuals with `No intervention` and where `intervention_type` is `NA`

```{r}
records_to_exclude <- interv_summary %>% 
  filter(total_interventions == 0)

records_to_exclude %>% 
  length()
```
Only three unique `id` by `case` combinations have NO intervention data.

```{r}
exclude_these <- records_to_exclude %>% 
  mutate(exclude_id_case = paste(id, case, sep = "_")) %>% 
  pull(exclude_id_case) 
```


```{r}
dim(op_1)

op_1 <- op_1 %>% 
  mutate(id_case = paste(id, case, sep = "_")) %>% 
  filter(!id_case %in% exclude_these)

dim(op_1)
```

Now--let's exclude those selected already from the `op_1` pool to run our `op_2` pool, then apply the filters as above, and lastly combine them for sampling.

  - Option 2: Has at least one intervention with date 10/1/22 or later (regardless of case start date or blank start date)

```{r}
op_2 <- dat %>% 
  anti_join(op_1)

op_2_inver_dates <- op_2 %>%
  select(id, starts_with("intervention") & ends_with("date")) %>% 
  pivot_longer(starts_with("intervention") & ends_with("date"), names_to = "intervention", values_to = "date")

op_2_inver_dates %>% 
  head()
```

```{r}
op_2_inver_dates <- op_2_inver_dates %>% 
  filter(date >= lubridate::ymd("2022-10-01") & date <= lubridate::ymd("2023-10-01"))

```


```{r}
summary(op_2_inver_dates$date)
```


```{r}
include_these <- op_2_inver_dates %>% 
  select(id) %>% 
  unique() %>% 
  pull(id)
```


```{r}
op_2 <- dat %>% 
  filter(id %in% include_these)
```

Combine `id`s from option 1 and 2.

```{r}
sample_subset <- op_1  %>% 
  bind_rows(op_2)
```

Percent of those from original data who made the cut-off.

```{r}
nrow(sample_subset)/nrow(raw)
```


# Data cleaning

Do any `ids` occur more than once?

```{r}
sample_subset <- sample_subset %>% 
  add_count(id, name = "id_count")

sample_subset %>% 
  count(id) %>% 
  filter(n > 1) %>% 
  nrow()
```

It appears there are 205 `id`'s with more than once case.

In order to limit the sampling to the most **recent** case per ID, I will first, `group_by` `id`, then sort descending by `case_start_date`, and finally `slice` for the first occurrence (i.e. most recent case by `id`).

```{r}
# Quick sanity check before running below

sample_subset %>% 
    filter(id_count > 1) %>% 
    group_by(id) %>% 
    arrange(id, desc(case_start_date_recode)) %>% 
    head()

sample_subset <- sample_subset %>% 
  group_by(id) %>% 
  arrange(id, desc(case_start_date_recode)) %>% 
  slice(1) %>% 
  ungroup()
```

Evaluate `100315` to double check that the correct one was selected.

```{r}
sample_subset %>% 
  filter(id == 100315)
```
Looks good.



# Random sample

First quickly glimpse at what the N is for reporting agencies w/ the smallest sizes.

```{r}
sample_subset %>% 
  count(reporting_agency) %>% 
  arrange(n) %>% 
  head()
```

Some reporting agencies have less than 10 cases.

Assign agency as a `small_agency` (10 cases or less) or `not_small` (more than 10 cases)

```{r, message = FALSE}
sample_subset <- sample_subset %>% 
  add_count(reporting_agency) %>% 
  mutate(`agency_size` = if_else(n <= 10, "small_agency", "not_small"))

small_agencies <- sample_subset %>% 
  filter(agency_size == "small_agency") %>% 
  droplevels()

all_other_agencies <- sample_subset %>% 
  anti_join(small_agencies) %>% 
  droplevels()
```

# Alternative I.

If N < 10 capture `10%  across all SMALL agencies or just capture 1 per agency 
Anything more we capture `15%`

```{r}
set.seed(123)

random_sample_small_agencies_i <- small_agencies %>% 
  group_by(reporting_agency) %>% 
  sample_n(1)
```




# Sample all other agencies

```{r}
all_other_agencies <- all_other_agencies %>% 
  mutate(sample_n = ceiling(n*0.15))

set.seed(123)

random_sample_other_agencies <- all_other_agencies %>% 
  group_by(reporting_agency) %>% 
  group_modify(~sample_n(.x, sample_n[1])) %>% 
  ungroup()
```


# Distribution of samples

The smaller agencies

```{r}
dist_small <- small_agencies %>% 
  ungroup() %>% 
  select(race_1, ethnicity, reporting_agency) %>% 
  pivot_longer(everything(), names_to = "variable") %>% 
  group_by(variable, value) %>% 
  summarise(n = n()) %>% 
  ungroup(value) %>% 
  mutate(statistic = n/sum(n)) %>% 
  bind_rows(
    small_agencies %>% 
    summarise(variable = "age",
              sd = sd(age, na.rm = T),
              statistic = mean(age, na.rm = T))
  ) %>% 
  mutate(across(where(is.numeric), ~round(.x, 2))) %>% 
  mutate(sample = "Full Sample") %>% 
  mutate(statistic = case_when(variable == "age" ~ paste(statistic, " (", sd, ")", sep = ""),
                               is.na(statistic) ~ NA,
                               TRUE ~ paste(n, " ", "(", statistic*100, "%",")", sep = ""))) %>% 
  select(variable, value, statistic, sample)
  

dist_small_i <- random_sample_small_agencies_i %>% 
  select(race_1, ethnicity, reporting_agency) %>% 
  pivot_longer(everything(), names_to = "variable") %>% 
  group_by(variable, value) %>% 
  summarise(n = n()) %>% 
  ungroup(value) %>% 
  mutate(statistic = n/sum(n)) %>% 
  bind_rows(
    small_agencies %>% 
    summarise(variable = "age",
              sd = sd(age, na.rm = T),
              statistic = mean(age, na.rm = T))
  ) %>% 
  mutate(across(where(is.numeric), ~round(.x, 2))) %>% 
  mutate(sample = "Random Sample I") %>% 
  mutate(statistic = case_when(variable == "age" ~ paste(statistic, " (", sd, ")", sep = ""),
                               is.na(statistic) ~ NA,
                               TRUE ~ paste(n, " ", "(", statistic*100, "%",")", sep = ""))) %>% 
  select(variable, value, statistic, sample)


full_stats_small_agency <- dist_small %>% 
  bind_rows(dist_small_i) %>% 
  pivot_wider(names_from = sample, values_from = statistic)

full_stats_small_agency
```

All other agencies

```{r}
dist_other <- all_other_agencies %>% 
  ungroup() %>% 
  select(race_1, ethnicity, reporting_agency) %>% 
  pivot_longer(everything(), names_to = "variable") %>% 
  group_by(variable, value) %>% 
  summarise(n = n()) %>% 
  ungroup(value) %>% 
  mutate(statistic = n/sum(n)) %>% 
  bind_rows(
    all_other_agencies %>% 
    summarise(variable = "age",
              sd = sd(age, na.rm = T),
              statistic = mean(age, na.rm = T))
  ) %>% 
  mutate(across(where(is.numeric), ~round(.x, 2))) %>% 
  mutate(sample = "Full Sample") %>% 
  mutate(statistic = case_when(variable == "age" ~ paste(statistic, " (", sd, ")", sep = ""),
                               is.na(statistic) ~ NA,
                               TRUE ~ paste(n, " ", "(", statistic*100, "%",")", sep = ""))) %>% 
  select(variable, value, statistic, sample)
  

dist_other_sample <- random_sample_other_agencies %>% 
  select(race_1, ethnicity, reporting_agency) %>% 
  pivot_longer(everything(), names_to = "variable") %>% 
  group_by(variable, value) %>% 
  summarise(n = n()) %>% 
  ungroup(value) %>% 
  mutate(statistic = n/sum(n)) %>% 
  bind_rows(
    random_sample_other_agencies %>% 
    summarise(variable = "age",
              sd = sd(age, na.rm = T),
              statistic = mean(age, na.rm = T))
  ) %>% 
  mutate(across(where(is.numeric), ~round(.x, 2))) %>% 
  mutate(sample = "Random Sample I") %>% 
  mutate(statistic = case_when(variable == "age" ~ paste(statistic, " (", sd, ")", sep = ""),
                               is.na(statistic) ~ NA,
                               TRUE ~ paste(n, " ", "(", statistic*100, "%",")", sep = ""))) %>% 
  select(variable, value, statistic, sample)


full_stats_other_agency <- dist_other %>% 
  bind_rows(dist_other_sample) %>% 
  pivot_wider(names_from = sample, values_from = statistic)

full_stats_other_agency
```

# Total N sampled

```{r}
random_sample_other_agencies %>% 
  nrow()

random_sample_small_agencies_i %>% 
  nrow()
```

Now--I will use the combination of `id` and `case` number to subset the first random sample from the `raw` (original) sample_subseta.

```{r}
small_agencies_id <- paste(random_sample_small_agencies_i$id, random_sample_small_agencies_i$case, sep = "_")
  
other_agencies <- paste(random_sample_other_agencies$id, random_sample_other_agencies$case, sep = "_")  
 
raw_sample <- raw %>% 
  filter(paste(id, case, sep = "_") %in% c(small_agencies_id, other_agencies))
```

Make sure that only ONE `id` is selected in the raw sample.

```{r}
raw_sample %>% 
  count(id) %>% 
  arrange(desc(n)) %>% 
  head()
```

Save the `id` and `case` selected in this iteration as a `tibble`

```{r}
selected_id_case <- tibble(
  id_case = c(other_agencies, small_agencies_id)
)
```

# Export samples and stats

```{r}
output <- list(id_case_selected = selected_id_case,
               stats_small_agency = full_stats_small_agency, 
               stats_all_other_agency = full_stats_other_agency)

writexl::write_xlsx(output, "stats_randomized_sample_v2.xlsx")

write.csv(raw_sample, "randomized_sample_v2.csv", row.names = F)

write.csv(raw, "og_file_used_v2.csv")
```

